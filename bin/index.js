
var ds = require('node-ds');
var util = require('node-util');

var net = require('net');
'use strict';var polina={};polina.VERSION="0.0.1";polina.beans={};polina.redis={};polina.nop=function(){};polina.__SEED=254181424;
polina.murmur=function(str){var l=str.length,h=polina.__SEED^l,i=0,k=0;while(l>=4){k=str.charCodeAt(i)&255|(str.charCodeAt(i+=1)&255)<<8|(str.charCodeAt(i+=1)&255)<<16|(str.charCodeAt(i+=1)&255)<<24;k=(k&65535)*1540483477+(((k>>>16)*1540483477&65535)<<16);k^=k>>>24;k=(k&65535)*1540483477+(((k>>>16)*1540483477&65535)<<16);h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)^k;l-=4;i+=1}switch(l){case 3:h^=(str.charCodeAt(i+2)&255)<<16;case 2:h^=(str.charCodeAt(i+1)&255)<<8;case 1:h^=str.charCodeAt(i)&
255;h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)}h^=h>>>13;h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16);h^=h>>>15;return h>>>0};polina.IPacketHandler=function(){};polina.IPacketHandler.prototype.isComplete=function(){};polina.IPacketHandler.prototype.process=function(cursor,chunk){};polina.IPacketHandler.prototype.reset=function(){};polina.Connection=function(port,opt_host){var self=this;var isFlushRequested=false;function reconnect(){self.__connect()}function fallback(){self.__fallback()}function flush(){isFlushRequested=false;self.__flush()}this.__destinations=[arguments];this.__destinationIndex=0;this.__socket=new net.Socket;this.__requestHandlers=new ds.queue.Queue;this.__processQueue=new ds.queue.Queue;this.__writeQueue=[];this.__readBuffer=new Buffer(0);this.__isConnected=false;this.__isDisconnecting=false;this.__isConnecting=
false;this.__nextTickFlush=function(){if(!isFlushRequested){isFlushRequested=true;process.nextTick(flush)}};this.__handleConnection=function(){self.__readBuffer=new Buffer(0);self.__isConnected=true;self.__isConnecting=false;while(self.__processQueue.length>0)self.__writeQueue.push(self.__processQueue.shift());if(self.__requestHandlers.length>0){var currentHandler=self.__requestHandlers.getFirst().get();currentHandler.reset();if(currentHandler===self._getHandshakeHandler())self.__nextTickFlush();
else self.__handshake()}else self.__handshake();if(self.__isDisconnecting)self.__socket.end()};this.__handleData=function(chunk){if(self.__readBuffer.length>0)self.__readBuffer=Buffer.concat([self.__readBuffer,chunk]);else self.__readBuffer=chunk;self.__processData()};this.__handleClose=function(){self.__isConnected=false;if(self.__isConnecting)setTimeout(fallback,1E3);else if(self.__isDisconnecting)self.__isDisconnecting=false;else setTimeout(reconnect,1E3);self.__socket.removeAllListeners();self.__socket.destroy()};
this.__connect()};polina.Connection.prototype.registerFallback=function(port,opt_host){this.__destinations.push(arguments)};polina.Connection.prototype.destroy=function(){this.__socket.removeAllListeners();this.__socket.end()};polina.Connection.prototype._send=function(payload,handler){this.__writeQueue.push(payload);this.__requestHandlers.push(handler);this.__nextTickFlush()};polina.Connection.prototype._getHandshakePayload=function(){return""};polina.Connection.prototype._getHandshakeHandler=function(){return null};
polina.Connection.prototype.__fallback=function(){this.__destinationIndex=(this.__destinationIndex+1)%this.__destinations.length;this.__connect()};
polina.Connection.prototype.__processData=function(){var cursor=0;while(this.__requestHandlers.length>0&&this.__readBuffer.length>0){var handler=this.__requestHandlers.getFirst().get();var prevPosition=cursor;cursor=handler.process(cursor,this.__readBuffer);if(handler.isComplete()){this.__requestHandlers.shift();this.__processQueue.shift()}if(cursor===prevPosition)break}this.__readBuffer=this.__readBuffer.slice(cursor)};
polina.Connection.prototype.__connect=function(){var args=this.__destinations[this.__destinationIndex];this.__isConnecting=true;this.__socket.addListener("connect",this.__handleConnection);this.__socket.addListener("data",this.__handleData);this.__socket.addListener("close",this.__handleClose);this.__socket.addListener("error",function(err){console.error("(polina) Connection failed",args,err)});this.__socket.connect.apply(this.__socket,args)};
polina.Connection.prototype.__flush=function(){if(this.__isConnected&&this.__writeQueue.length>0){var i=0,l=this.__writeQueue.length;while(i<l){this.__processQueue.push(this.__writeQueue[i]);i+=1}this.__socket.write(this.__writeQueue.join(""));this.__writeQueue.length=0}};
polina.Connection.prototype.__handshake=function(){var handshakePayload=this._getHandshakePayload();if(handshakePayload.length>0){var handshakeHandler=this._getHandshakeHandler();if(handshakeHandler!==null){handshakeHandler.reset();this.__requestHandlers.unshift(handshakeHandler);this.__writeQueue.unshift(handshakePayload)}}this.__nextTickFlush()};polina.beans.Client=function(handshakePayload,handshakeHandler,port,opt_host){polina.Connection.call(this,port,opt_host);this.__handshakePayload=handshakePayload;this.__handshakeHandler=handshakeHandler};util.inherits(polina.beans.Client,polina.Connection);polina.beans.Client.prototype._getHandshakePayload=function(){return this.__handshakePayload};polina.beans.Client.prototype._getHandshakeHandler=function(){return this.__handshakeHandler};
polina.beans.Client.prototype._command=function(name,args,response,callback,opt_data){var payload=name;if(args.length>0)payload+=" "+args;if(opt_data!==undefined)payload+=" "+Buffer.byteLength(opt_data)+"\r\n"+opt_data;this._send(payload+"\r\n",new polina.beans.PacketHandler(response,callback))};polina.beans.User=function(tube,port,opt_host){polina.beans.Client.call(this,"use "+tube+"\r\n",new polina.beans.PacketHandler("USING"),port,opt_host)};util.inherits(polina.beans.User,polina.beans.Client);polina.beans.User.prototype.put=function(priority,timeout,execTime,data,opt_callback){this._command("put",priority+" "+timeout+" "+execTime,"INSERTED",opt_callback||null,data)};
polina.beans.User.prototype.peekReady=function(complete){this._command("peek-ready","","FOUND",function(error,jid,data){if(error!==null)complete("","");else complete(jid,data)})};polina.beans.User.prototype.delete=function(jid,callback){this._command("delete",jid,"DELETED",function(error){if(error!==null)console.error("(polina) Beans delete error: "+error.message);callback()})};polina.beans.Watcher=function(tube,port,opt_host){polina.beans.Client.call(this,"watch "+tube+"\r\n",new polina.beans.PacketHandler("WATCHING"),port,opt_host);this.__currentJid=polina.beans.Watcher.__EMPTY_JID;this.__isDestroyed=false};util.inherits(polina.beans.Watcher,polina.beans.Client);polina.beans.Watcher.__EMPTY_JID="";
polina.beans.Watcher.prototype.reserve=function(callback){var self=this;this._command("reserve","","RESERVED",function(error,jid,data){if(error!==null)console.error("(polina) Beans reserve error: "+error.message);else{self.__currentJid=jid;callback(jid,data)}})};polina.beans.Watcher.prototype.delete=function(jid,callback){var self=this;this._command("delete",jid,"DELETED",function(error){if(error!==null)console.error("(polina) Beans delete error: "+error.message);else{self.__resetJobId();callback()}})};
polina.beans.Watcher.prototype.release=function(jid,priority,timeout,callback){var self=this;var args=jid+" "+priority+" "+timeout;this._command("release",args,"RELEASED",function(error){if(error===null){self.__resetJobId();callback()}else self.destroy()})};polina.beans.Watcher.prototype.__resetJobId=function(){this.__currentJid=polina.beans.Watcher.__EMPTY_JID;if(this.__isDestroyed)this.destroy()};polina.beans.Watcher.prototype.destroy=function(){this.__isDestroyed=true;if(this.__currentJid===polina.beans.Watcher.__EMPTY_JID)polina.beans.Client.prototype.destroy.call(this)};polina.beans.PacketHandler=function(expectedResponse,opt_callback){this.__expectedResponse=expectedResponse;this.__isHeadParsed=false;this.__header=[];this.__body="";this.__isComplete=false;this.__callback=opt_callback||polina.nop};polina.beans.PacketHandler.prototype.reset=function(){this.__isHeadParsed=false;this.__header.length=0;this.__body="";this.__isComplete=false};polina.beans.PacketHandler.prototype.isComplete=function(){return this.__isComplete};
polina.beans.PacketHandler.prototype.process=function(cursor,chunk){if(!this.__isHeadParsed){var i=cursor;while(i<chunk.length){if(chunk[i]===10){this.__isHeadParsed=true;this.__header=chunk.slice(cursor,i-1).toString().split(" ");i+=1;break}i+=1}if(this.__isHeadParsed)cursor=i}if(this.__isHeadParsed)if(this.__header[0]==="RESERVED"||this.__header[0]==="FOUND"||this.__header[0]==="OK"){var payloadLength=parseInt(this.__header[this.__header.length-1],10);if(chunk.length>=cursor+payloadLength+2){this.__isComplete=
true;this.__body=chunk.slice(cursor,cursor+payloadLength).toString();cursor+=payloadLength+2}}else this.__isComplete=true;if(this.__isComplete){var error=null;if(this.__header[0]!==this.__expectedResponse)error=Error(this.__header[0]);this.__callback(error,this.__header[1]||"",this.__body)}return cursor};polina.beans.UsersBundle=function(tube,ports,opt_hosts){var self=this;var hosts=opt_hosts||[];this.__robinCounter=0;this.__robinRequested=false;this.__users=new Array(ports.length);this.__incrementRobin=function(){self.__robinCounter+=1;self.__robinRequested=false};var i=0,l=this.__users.length;while(i<l){this.__users[i]=new polina.beans.User(tube,ports[i],hosts[i]);i+=1}};
polina.beans.UsersBundle.prototype.put=function(priority,timeout,execTime,data,opt_callback){var user=this.__users[this.__robinCounter%this.__users.length];if(user!==undefined)user.put(priority,timeout,execTime,data,opt_callback);if(!this.__robinRequested){this.__robinRequested=true;process.nextTick(this.__incrementRobin)}};polina.beans.UsersBundle.prototype.destroy=function(){while(this.__users.length>0)this.__users.shift().destroy()};polina.redis.ResponseType={OK:"+".charCodeAt(0),ERR:"-".charCodeAt(0),INT:":".charCodeAt(0),BULK:"$".charCodeAt(0),MULTI_BULK:"*".charCodeAt(0)};polina.redis.IClient=function(){};polina.redis.IClient.prototype.set=function(key,value,complete,cancel){};polina.redis.IClient.prototype.incrby=function(key,value,complete,cancel){};polina.redis.IClient.prototype.incr=function(key,complete,cancel){};polina.redis.IClient.prototype.decr=function(key,complete,cancel){};polina.redis.IClient.prototype.setex=function(key,seconds,value,complete,cancel){};polina.redis.IClient.prototype.expire=function(key,seconds,complete,cancel){};
polina.redis.IClient.prototype.get=function(key,complete,cancel){};polina.redis.IClient.prototype.mget=function(keys,complete,cancel){};polina.redis.IClient.prototype.keys=function(pattern,complete,cancel){};polina.redis.IClient.prototype.del=function(key,complete,cancel){};polina.redis.IClient.prototype.sadd=function(key,value,complete,cancel){};polina.redis.IClient.prototype.srem=function(key,value,complete,cancel){};polina.redis.IClient.prototype.sismember=function(key,value,complete,cancel){};
polina.redis.IClient.prototype.smembers=function(key,complete,cancel){};polina.redis.IClient.prototype.destroy=function(){};polina.redis.Client=function(port,opt_host){polina.Connection.call(this,port,opt_host)};util.inherits(polina.redis.Client,polina.Connection);polina.redis.Client.prototype.__encodeCommand=function(args){var command="";if(args.length>0){var i=0,l=args.length;command="*"+l+"\r\n";while(i<l){command+="$"+Buffer.byteLength(args[i])+"\r\n"+args[i]+"\r\n";i+=1}}return command};
polina.redis.Client.prototype.__intCommand=function(args,complete,cancel){this._send(this.__encodeCommand(args),new polina.redis.PacketHandler(complete,cancel,0))};polina.redis.Client.prototype.__strCommand=function(args,complete,cancel){this._send(this.__encodeCommand(args),new polina.redis.PacketHandler(complete,cancel,1))};polina.redis.Client.prototype.__arrCommand=function(args,complete,cancel){this._send(this.__encodeCommand(args),new polina.redis.PacketHandler(complete,cancel,2))};
polina.redis.Client.prototype.set=function(key,value,complete,cancel){this.__strCommand(["SET",key,value],complete,cancel)};polina.redis.Client.prototype.incrby=function(key,value,complete,cancel){this.__intCommand(["INCRBY",key,String(value)],complete,cancel)};polina.redis.Client.prototype.incr=function(key,complete,cancel){this.__intCommand(["INCR",key],complete,cancel)};polina.redis.Client.prototype.decr=function(key,complete,cancel){this.__intCommand(["DECR",key],complete,cancel)};
polina.redis.Client.prototype.setex=function(key,seconds,value,complete,cancel){this.__strCommand(["SETEX",key,String(seconds),value],complete,cancel)};polina.redis.Client.prototype.expire=function(key,seconds,complete,cancel){this.__intCommand(["EXPIRE",key,String(seconds)],complete,cancel)};polina.redis.Client.prototype.get=function(key,complete,cancel){this.__strCommand(["GET",key],complete,cancel)};
polina.redis.Client.prototype.mget=function(keys,complete,cancel){this.__arrCommand(["MGET"].concat(keys),complete,cancel)};polina.redis.Client.prototype.keys=function(pattern,complete,cancel){this.__arrCommand(["KEYS",pattern],complete,cancel)};polina.redis.Client.prototype.del=function(key,complete,cancel){this.__intCommand(["DEL"].concat(key),complete,cancel)};polina.redis.Client.prototype.sadd=function(key,value,complete,cancel){this.__intCommand(["SADD",key].concat(value),complete,cancel)};
polina.redis.Client.prototype.srem=function(key,value,complete,cancel){this.__intCommand(["SREM",key].concat(value),complete,cancel)};polina.redis.Client.prototype.sismember=function(key,value,complete,cancel){this.__intCommand(["SREM",key,value],complete,cancel)};polina.redis.Client.prototype.smembers=function(key,complete,cancel){this.__arrCommand(["SMEMBERS",key],complete,cancel)};polina.redis.Bucket=function(size){this.__size=size;this.__bucket={};this.__clients={};this.__intervals={}};polina.redis.Bucket.prototype.resize=function(size){this.__size=size};
polina.redis.Bucket.prototype.registerClient=function(intervalStart,intervalEnd,client,id){this.terminateClient(id);if(intervalStart<0)intervalStart=0;if(intervalEnd>this.__size)intervalEnd=this.__size;var i=intervalStart;while(i<intervalEnd){this.__bucket[i]=client;i+=1}this.__clients[id]=client;this.__intervals[id]=[intervalStart,intervalEnd]};
polina.redis.Bucket.prototype.terminateClient=function(id){if(this.__clients[id]!==undefined){var interval=this.__intervals[id];var i=interval[0];while(i<interval[1]){delete this.__bucket[i];i+=1}this.__clients[id].destroy();delete this.__intervals[id];delete this.__clients[id]}};polina.redis.Bucket.prototype.__getIndex=function(key){return polina.murmur(key)%this.__size};
polina.redis.Bucket.prototype.set=function(key,value,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.set(key,value,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.incrby=function(key,value,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.incrby(key,value,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.incr=function(key,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.incr(key,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.decr=function(key,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.decr(key,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.setex=function(key,seconds,value,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.setex(key,seconds,value,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.expire=function(key,seconds,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.expire(key,seconds,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.get=function(key,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.get(key,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.mget=function(keys,complete,cancel){var client=this.__bucket[this.__getIndex(keys[0])];if(client!==undefined)client.mget(keys,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.keys=function(pattern,complete,cancel){var client=this.__bucket[this.__getIndex(pattern)];if(client!==undefined)client.keys(pattern,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.del=function(key,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.del(key,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.sadd=function(key,value,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.sadd(key,value,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.srem=function(key,value,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.srem(key,value,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.sismember=function(key,value,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.sismember(key,value,complete,cancel);else cancel("Redis bucket is incomplete.")};polina.redis.Bucket.prototype.smembers=function(key,complete,cancel){var client=this.__bucket[this.__getIndex(key)];if(client!==undefined)client.smembers(key,complete,cancel);else cancel("Redis bucket is incomplete.")};
polina.redis.Bucket.prototype.destroy=function(){for(var key in this.__clients)this.__clients[key].destroy();this.__bucket={};this.__clients={};this.__intervals={}};polina.redis.PacketHandler=function(complete,cancel,type){this.__typeCode=-1;this.__bulkTypeCode=-1;this.__isTypeParsed=false;this.__isBulkTypeParsed=false;this.__isTypeReady=false;this.__isBulkTypeReady=false;this.__typeValue=0;this.__bulkTypeValue=0;this.__isTypeNegative=false;this.__isBulkTypeNegative=false;this.__isComplete=false;this.__arrayResult=[];this.__stringResult="";this.__intResult=0;this.__errorHandler=cancel;this.__resultHandler=complete;this.__resultType=type};
polina.redis.PacketHandler.prototype.reset=function(){this.__typeCode=-1;this.__bulkTypeCode=-1;this.__isTypeParsed=false;this.__isBulkTypeParsed=false;this.__isTypeReady=false;this.__isBulkTypeReady=false;this.__typeValue=0;this.__bulkTypeValue=0;this.__isTypeNegative=false;this.__isBulkTypeNegative=false;this.__isComplete=false;this.__arrayResult=[];this.__stringResult="";this.__intResult=0};polina.redis.PacketHandler.prototype.isComplete=function(){return this.__isComplete};
polina.redis.PacketHandler.prototype.process=function(cursor,chunk){var initPosition=cursor;if(this.__typeCode===-1&&chunk.length>cursor){this.__typeCode=chunk[cursor];cursor+=1}if(!this.__isTypeParsed){this.__typeValue=0;this.__isTypeNegative=false;var i=cursor;while(i<chunk.length){if(chunk[i]===13){this.__isTypeParsed=true;i+=1;break}if(chunk[i]===45)this.__isTypeNegative=true;else this.__typeValue=this.__typeValue*10+(chunk[i]-48);i+=1}if(this.__isTypeParsed)cursor=i}if(this.__isTypeParsed&&!this.__isTypeReady)if(chunk[cursor]===
10&&chunk.length>cursor){this.__isTypeReady=true;cursor+=1}if(this.__isTypeReady)switch(this.__typeCode){case polina.redis.ResponseType.OK:this._complete();break;case polina.redis.ResponseType.ERR:this._cancel(chunk.slice(initPosition+1,cursor-2));break;case polina.redis.ResponseType.INT:this.__intResult=(this.__isTypeNegative?-1:1)*this.__typeValue;this._complete();break;case polina.redis.ResponseType.BULK:cursor=this.__extractBulk(cursor,chunk);break;case polina.redis.ResponseType.MULTI_BULK:cursor=
this.__extractMultiBulk(cursor,chunk);break}return cursor};polina.redis.PacketHandler.prototype._complete=function(){this.__isComplete=true;if(this.__resultType===0)this.__resultHandler(this.__intResult);else if(this.__resultType===1)this.__resultHandler(this.__stringResult);else if(this.__resultType===2)this.__resultHandler(this.__arrayResult)};polina.redis.PacketHandler.prototype._cancel=function(error){this.__isComplete=true;this.__errorHandler(error.toString())};
polina.redis.PacketHandler.prototype.__extractBulk=function(cursor,chunk){if(this.__isTypeNegative)this._complete();else if(chunk.length>=cursor+this.__typeValue+2){this.__stringResult=chunk.slice(cursor,cursor+this.__typeValue).toString();this._complete();return cursor+this.__typeValue+2}return cursor};
polina.redis.PacketHandler.prototype.__extractMultiBulk=function(cursor,chunk){if(this.__isTypeNegative)this._complete();else{while(this.__arrayResult.length<this.__typeValue){var prevPosition=cursor;cursor=this.__extractMultiBulkItem(cursor,chunk);if(prevPosition===cursor)break}if(this.__arrayResult.length>=this.__typeValue)this._complete()}return cursor};
polina.redis.PacketHandler.prototype.__extractMultiBulkItem=function(cursor,chunk){if(this.__bulkTypeCode===-1&&chunk.length>cursor){this.__bulkTypeCode=chunk[cursor];cursor+=1}if(!this.__isBulkTypeParsed){this.__bulkTypeValue=0;this.__isBulkTypeNegative=false;var i=cursor;while(i<chunk.length){if(chunk[i]===13){this.__isBulkTypeParsed=true;i+=1;break}if(chunk[i]===45)this.__isBulkTypeNegative=true;else this.__bulkTypeValue=this.__bulkTypeValue*10+(chunk[i]-48);i+=1}if(this.__isBulkTypeParsed)cursor=
i}if(this.__isBulkTypeParsed&&!this.__isBulkTypeReady)if(chunk[cursor]===10){this.__isBulkTypeReady=true;cursor+=1}if(this.__isBulkTypeReady)switch(this.__bulkTypeCode){case polina.redis.ResponseType.INT:this.__addBulk((this.__isBulkTypeNegative?-1:1)*this.__bulkTypeValue);break;case polina.redis.ResponseType.BULK:if(this.__isBulkTypeNegative)this.__addBulk();else if(chunk.length>=cursor+this.__bulkTypeValue+2){this.__addBulk(chunk.slice(cursor,cursor+this.__bulkTypeValue));cursor+=this.__bulkTypeValue+
2}break}return cursor};polina.redis.PacketHandler.prototype.__addBulk=function(opt_data){if(opt_data!==undefined)this.__arrayResult.push(String(opt_data));else this.__arrayResult.push("");this.__bulkTypeCode=-1;this.__isBulkTypeParsed=false;this.__isBulkTypeReady=false};polina.redis.Bundle=function(count,port,opt_host){var self=this;this.__currentClient=new polina.redis.Client(port,opt_host);this.__clients=[this.__currentClient];this.__robin=0;this.__updateRequested=false;this.__updateClient=function(){self.__robin+=1;self.__updateRequested=false;self.__currentClient=self.__clients[self.__robin%self.__clients.length]};var i=1;while(i<count){this.__clients.push(new polina.redis.Client(port,opt_host));i+=1}};
polina.redis.Bundle.prototype.registerFallback=function(port,opt_host){var i=0,l=this.__clients.length;while(i<l){this.__clients[i].registerFallback(port,opt_host);i+=1}};polina.redis.Bundle.prototype.__updateCurrentClient=function(){if(!this.__updateRequested){this.__updateRequested=true;process.nextTick(this.__updateClient)}};polina.redis.Bundle.prototype.set=function(key,value,complete,cancel){this.__currentClient.set(key,value,complete,cancel);this.__updateCurrentClient()};
polina.redis.Bundle.prototype.incrby=function(key,value,complete,cancel){this.__currentClient.incrby(key,value,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.incr=function(key,complete,cancel){this.__currentClient.incr(key,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.decr=function(key,complete,cancel){this.__currentClient.decr(key,complete,cancel);this.__updateCurrentClient()};
polina.redis.Bundle.prototype.setex=function(key,seconds,value,complete,cancel){this.__currentClient.setex(key,seconds,value,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.expire=function(key,seconds,complete,cancel){this.__currentClient.expire(key,seconds,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.get=function(key,complete,cancel){this.__currentClient.get(key,complete,cancel);this.__updateCurrentClient()};
polina.redis.Bundle.prototype.mget=function(keys,complete,cancel){this.__currentClient.mget(keys,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.keys=function(pattern,complete,cancel){this.__currentClient.keys(pattern,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.del=function(key,complete,cancel){this.__currentClient.del(key,complete,cancel);this.__updateCurrentClient()};
polina.redis.Bundle.prototype.sadd=function(key,value,complete,cancel){this.__currentClient.sadd(key,value,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.srem=function(key,value,complete,cancel){this.__currentClient.srem(key,value,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.sismember=function(key,value,complete,cancel){this.__currentClient.sismember(key,value,complete,cancel)};
polina.redis.Bundle.prototype.smembers=function(key,complete,cancel){this.__currentClient.smembers(key,complete,cancel);this.__updateCurrentClient()};polina.redis.Bundle.prototype.destroy=function(){var i=0,l=this.__clients.length;while(i<l){this.__clients[i].destroy();i+=1}};
module.exports = polina;

